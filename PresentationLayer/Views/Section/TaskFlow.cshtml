@{
    Layout = "TaskFlowLayout";
}
@using Application.DTOs
@model List<Application.DTOs.ProjectDto>

<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<link rel="stylesheet" href="~/css/TaskFlowStyleSheet.css"/>

<div class="main-container">

    <div class="recently-viewed-section">
        @if (ViewBag.LastVisitedSections is List<RecentSectionCookieDto> && ViewBag.LastVisitedSections.Count > 0)
        {
            <div class="section-header">
                <i class="fa-regular fa-clock"></i> <span>Last Visited</span>
            </div>
        }
        
        <div class="boards-grid">
            @if (ViewBag.LastVisitedSections is List<RecentSectionCookieDto> visitedSections)
            {
                foreach (var visitedSection in visitedSections)
                {
                    <div class="board-card has-bg"
                         onclick="window.location.href='/Section/SectionTasks?sectionId=@visitedSection.Id'"
                         style="background-image: url('@visitedSection.ImageUrl'); background-size: cover; background-position: center;">
                        <span class="board-title-text">@visitedSection.Name</span>
                    </div>
                }
            }
        </div>
    </div>

    <div class="section-header-container">
        <div class="section-header">
            <i class="fa-solid fa-briefcase"></i> <span>Workspaces</span>
        </div>
        <button class="btn-create-new-project" onclick="NewWorkspaceClick()">
            <i class="fa-solid fa-plus"></i> New Workspace
        </button>
    </div>

    <div class="workspaces-list">
        @foreach (var project in Model)
        {
            <div class="workspace-item">
                <div class="workspace-title-bar">
                    <div class="ws-left">
                        <div class="ws-icon">@project.Name[..1].ToUpper()</div>
        
                        <div class="ws-details">
                            <div class="ws-name">@project.Name</div>
    
                            @if (!string.IsNullOrEmpty(project.Description))
                            {
                                <div class="ws-description" title="@project.Description">
                                    @project.Description
                                </div>
                            }

                            <div class="ws-meta">
                                @if (project.StartDate != DateTime.MinValue)
                                {
                                    <div class="date-badge" title="Başlangıç Tarihi">
                                        <i class="fa-regular fa-calendar"></i>
                                        <span>@project.StartDate.ToString("dd MMM yyyy")</span>
                                    </div>
                                }

                                @if (project.EndDate.HasValue)
                                {
                                    var isOverdue = DateTime.Now > project.EndDate.Value;
                                    var badgeClass = isOverdue ? "date-badge overdue" : "date-badge";

                                    <div class="@badgeClass" title="Bitiş Tarihi">
                                        <i class="fa-solid fa-flag-checkered"></i>
                                        <span>@project.EndDate.Value.ToString("dd MMM yyyy")</span>
                                    </div>
                                }
                            </div>
                        </div>
                    </div>

                    <div class="ws-actions">
                        <button onclick="MembersButtonClick('@project.Id')">Members</button>
                        <button onclick="SettingsButtonClick(
                            '@project.Id', 
                            '@project.Name', 
                            '@project.Description',
                            '@project.StartDate.ToString("yyyy-MM-dd")',
                            '@(project.EndDate.HasValue ? project.EndDate.Value.ToString("yyyy-MM-dd") : "")')">
                            Settings
                        </button>
                    </div>
                </div>

                <div class="boards-grid">
                    @foreach (var projectSection in project.Sections)
                    {
                        <div class="board-card has-bg" 
                             onclick="window.location.href='/Section/SectionTasks?sectionId=@projectSection.Id'" 
                             style="background-image: url('@projectSection.ImageUrl'); background-size: cover; background-position: center;">
                            <span class="board-title-text">@projectSection.Name</span>
                        </div>
                    }
                    <div class="board-card new-board" onclick="NewSectionClick()">
                        <span>+ Create New Section</span>
                    </div>
                </div>
            </div>
        }
    </div>

</div>

<div id="dynamicModal" class="modal-overlay">
    <div class="modal-content">
        <div class="modal-header">
            <h3 id="modalTitle">Workspace Title</h3>
            <button class="close-btn" onclick="closeModal()">×</button>
        </div>
        <div id="modalBody" class="modal-body">
            </div>
        <div class="modal-footer">
            <button class="btn-cancel" onclick="closeModal()">Cancel</button>
            <button id="modalConfirmBtn" class="btn-confirm">Save</button>
        </div>
    </div>
</div>

<div id="sideModal" class="side-modal" style="display: none;"></div>

<template id="createSectionTemplate">
    <div class="create-board-container">
        <div id="boardPreview" class="board-preview-box" style="background-color: #0079bf;">
            <div class="preview-illustration">
                <div class="preview-col"></div>
                <div class="preview-col"></div>
                <div class="preview-col"></div>
            </div>
        </div>

        <div>
            <div class="bg-picker-title">Background</div>
            
            <div class="bg-grid-top" id="modalTopImages"></div>

            <div class="bg-grid-bot">
                <button class="bg-option-bot selected" onclick="selectBackground('#0079bf', 'color', this)" style="background-color: #0079bf;"></button>
                <button class="bg-option-bot" onclick="selectBackground('#d29034', 'color', this)" style="background-color: #d29034;"></button>
                <button class="bg-option-bot" onclick="selectBackground('#519839', 'color', this)" style="background-color: #519839;"></button>
                <button class="bg-option-bot" onclick="selectBackground('#b04632', 'color', this)" style="background-color: #b04632;"></button>
                <button class="bg-option-bot" onclick="selectBackground('#89609e', 'color', this)" style="background-color: #89609e;"></button>
                <button class="bg-option-bot" onclick="ShowAllBackgrounds(event)">...</button>
            </div>       
        </div>

        <div class="form-group">
            <label>Section Title <span style="color:red">*</span></label>
            <input type="text" id="newBoardName" class="form-input" placeholder="Example: Group Project Plan">
            <div id="inputError" style="color:red; font-size:12px; display:none; margin-top:5px;">⚠️ Section Title Needed</div>
        </div>

        <div class="form-group">
            <label>Workspace (Project)</label>
            <select id="workspaceSelect" class="form-select">
                @foreach (var project in Model)
                {
                    <option value="@project.Id">@project.Name</option>
                }
            </select>
        </div>

        <div class="form-group">
            <label>Visibility</label>
            <select class="form-select">
                <option>🔒 Private</option>
                <option>💼 Workspace</option>
            </select>
        </div>
    </div>
</template>
<template id="settingsTemplate">
    <div class="settings-container">
    
        <input type="hidden" id="editWsId">

        <div class="form-group">
            <label>Workspace Name</label>
            <input type="text" id="editWsName" class="form-input">
        </div>

        <div class="form-group">
            <label>Description</label>
            <textarea id="editWsDesc" class="form-textarea" placeholder="Description..."></textarea>
        </div>

        <div class="form-row" style="display: flex; gap: 15px;">
            <div class="form-group" style="flex: 1;">
                <label>Start Date</label>
                <input type="date" id="editWsStart" class="form-input">
            </div>
            <div class="form-group" style="flex: 1;">
                <label>End Date (Deadline)</label>
                <input type="date" id="editWsEnd" class="form-input">
                <small style="color: #64748b; font-size: 11px;">Optional</small>
            </div>
        </div>

        <div class="danger-zone">
            <div class="danger-title">
                <i class="fa-solid fa-triangle-exclamation"></i> Danger Zone
            </div>
            <div class="danger-desc">
                Deleting this workspace will permanently remove all associated boards and tasks. This action cannot be undone.
            </div>
            <button class="btn-danger" onclick="DeleteWorkspace()">
                <i class="fa-solid fa-trash"></i> Delete This Workspace
            </button>
        </div>
    </div>
</template>


<script src="~/js/TaskFlowScript.js"></script>